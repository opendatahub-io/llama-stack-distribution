name: Build and publish Red Hat Distribution Containers

on:
  # Trigger after test workflow completes successfully
  workflow_run:
    workflows: ["Run integration tests"]
    types:
      - completed
    branches:
      - main
      - rhoai-v*

  # build a custom image from an arbitrary llama-stack commit
  workflow_dispatch:
    inputs:
      llama_stack_commit_sha:
        description: 'Llama Stack commit SHA to build from - accept long and short commit SHAs'
        required: true
        type: string

concurrency:
  # For workflow_run events, use the head SHA; for workflow_dispatch, use the ref
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: quay.io
  IMAGE_NAME: quay.io/opendatahub/llama-stack # tags for the image will be added dynamically

jobs:
  # Build and publish job - builds container image and publishes to Quay.io
  # Only runs if integration tests pass (when triggered by workflow_run) or on manual dispatch
  build-and-publish:
    # Only run if:
    # 1. Triggered by workflow_run AND the test workflow succeeded, OR
    # 2. Triggered by workflow_dispatch (manual trigger)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      # When triggered by workflow_run, use the commit SHA from the test workflow
      # When triggered by workflow_dispatch, use the input or default to 'main'
      LLAMA_STACK_COMMIT_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.event.inputs.llama_stack_commit_sha || 'main' }}
      # For workflow_dispatch: use custom format with commit SHA
      # For workflow_run: use the commit SHA from the test workflow
      IMAGE_TAG: ${{ github.event_name == 'workflow_dispatch' && format('source-{0}-{1}', github.event.inputs.llama_stack_commit_sha || 'main', github.sha) || github.event.workflow_run.head_sha || github.sha }}
      # Image tags will be determined dynamically in the "Determine image tags" step
      IMAGE_TAGS: ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # When triggered by workflow_run, checkout the commit that triggered the test workflow
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          python-version: 3.12
          version: 0.7.6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Generate Containerfile to build an image from an arbitrary llama-stack commit (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        env:
          LLAMA_STACK_VERSION: ${{ env.LLAMA_STACK_COMMIT_SHA }}
        run: |
          tmp_build_dir=$(mktemp -d)
          git clone --filter=blob:none --no-checkout https://github.com/opendatahub-io/llama-stack.git "$tmp_build_dir"
          cd "$tmp_build_dir"
          git checkout "$LLAMA_STACK_VERSION"
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --no-cache -e .
          cd -
          python3 distribution/build.py
          sed -i '/^RUN pip install --no-cache llama-stack==/d' distribution/Containerfile

      - name: Log in to Quay.io
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Determine image tags
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "IMAGE_TAGS=${{ env.IMAGE_NAME }}:source-${{ env.LLAMA_STACK_COMMIT_SHA }}-${{ github.sha }}" >> "$GITHUB_ENV"
          else
            TAGS="${{ env.IMAGE_NAME }}:${{ github.sha }}"
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              TAGS="$TAGS,${{ env.IMAGE_NAME }}:latest"
            elif [[ "${{ github.ref }}" =~ ^refs/heads/rhoai-v ]]; then
              TAGS="$TAGS,${{ env.IMAGE_NAME }}:${{ github.ref_name }}-latest"
            fi
            echo "IMAGE_TAGS=$TAGS" >> "$GITHUB_ENV"
          fi

      - name: Publish image to Quay.io
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: distribution/Containerfile
          # TODO: enable other architectures once all pip packages are available for them
          platforms: linux/amd64
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output custom build information
        # Only output build info for manual workflow_dispatch triggers
        # For workflow_run triggers, build info is already available in the triggering workflow
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "âœ… Custom container image built successfully!"
          echo "ðŸ“¦ Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "ðŸ”— Llama Stack commit: ${{ env.LLAMA_STACK_COMMIT_SHA }}"
          echo ""
          echo "You can pull this image using:"
          echo "docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
